'use strict';
const application_id = process.env.APPLICATION_ID || 'SAP_HDI';
const logger = require('./logger');
const async = require('async');
const {prepareCredentials} = require('./utils');
const connections = require('./connections');

let vcap_application;

let space_name = '';
let org_name = '';
const is_hdb_enabled = logger.getHDBValue();
let hana_client;
if (is_hdb_enabled) {
  hana_client = require('hdb');
} else {
  hana_client = require('@sap/hana-client');
}

if (process.env.VCAP_APPLICATION) {
  vcap_application = JSON.parse(process.env.VCAP_APPLICATION);

  space_name = vcap_application.space_name || '';
  org_name = vcap_application.organization_name || '';
}

const APPLICATION = `${application_id}/${space_name}/${org_name}`;

/**
 * Add session variables like APPLICATION to the credentials.
 *
 * @param {any} credentials Bare credentials
 * @returns {Object} An enriched credentials object
 */
module.exports.enrich_credentials_with_session_variables = function (credentials = {}) {
  const enriched_creds = JSON.parse(JSON.stringify(credentials));
  enriched_creds['SESSIONVARIABLE:APPLICATION'] = APPLICATION;
  return enriched_creds;
};

module.exports.print_client_info = function (options, targetCreds, callback) {
  if (process.env.APPLICATION_VERSION_INFO) {
    logger.log(`Application version information: ${process.env.APPLICATION_VERSION_INFO}`);
  }
  let client;

  const sql = 'select * from sys.m_session_context where CONNECTION_ID=CURRENT_CONNECTION';

  const hdiCreds = this.enrich_credentials_with_session_variables(prepareCredentials(targetCreds, options, logger));

  if (is_hdb_enabled) {
    client = hana_client.createClient(hdiCreds);
  } else {
    client = hana_client.createConnection();
  }
  connections.push({client, file: __filename});

  let connection;

  if (is_hdb_enabled) {
    connection = [
      (cb) => client.connect(cb)
    ];
  } else {
    connection = [
      (cb) => client.connect(hdiCreds, cb)
    ];
  }
  connection.push((cb) => client.exec(sql, cb));

  async.series(connection, (error, [, session_context]) => {
    if (error) {
      logger.error(`Could not check if session variable APPLICATION is set correctly: ${error.message ? error.message : error}`);
    } else {
      const application = session_context.filter((r) => r.KEY === 'APPLICATION');
      if (application.length === 1) {
        logger.log(`Session variable APPLICATION is set to "${application[0].VALUE}".`);
      }
    }
    client.disconnect();
    return callback();
  });
};
