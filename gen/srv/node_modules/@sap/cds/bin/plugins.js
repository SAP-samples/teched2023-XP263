const cds = require('../lib')
const DEBUG = cds.debug('plugins')

module.exports = async function load_plugins (log = console.log) {

  if (DEBUG) console.time('[cds] - loaded plugins in')
  const plugins = []
  if (cds.env.plugins) {
    for (let each of cds.env.plugins) {
      let impl = typeof each === 'string' ? each : each.impl
      if (impl.startsWith('.'))
        impl = require.resolve(cds.root + '/' + impl)
      plugins.push(_load_plugin(impl, each))
    }
  } else
    try {
      const pkg = require(cds.root + '/package.json')
      const dependencies = { ...pkg.dependencies, ...(process.env.NODE_ENV !== 'production' && pkg.devDependencies) }
      for (let each in dependencies) {
        plugins.push(_load_plugin(each + '/cds-plugin'))
      }
    } catch { /* ignored */ }
  try { await Promise.all(plugins); } catch { /* ignored */ }
  if (DEBUG) console.timeEnd('[cds] - loaded plugins in')

  async function _load_plugin (impl, conf) {
    // TODO support ESM plugins.  But see cap/cds/pull/1838#issuecomment-1177200 !
    const plugin = require(impl)
    log('loaded plugin:', { impl })
    if (plugin.activate) await plugin.activate(conf)
  }
}
