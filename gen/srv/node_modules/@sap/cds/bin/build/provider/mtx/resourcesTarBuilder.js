const path = require('path')
const cds = require('../../cds')
const BuildTaskHandlerInternal = require('../buildTaskHandlerInternal')

const { BUILD_TASK_HANA } = require('../../constants')
const { fs } = require('../../../../lib/utils/cds-utils')
const { WARNING } = BuildTaskHandlerInternal
const DEFAULT_TAR_NAME = "resources.tgz"

class ResourcesTarBuilder {
    constructor(handler) {
        this._handler = handler
    }

    get handler() { return this._handler }

    async createTar(dest, model) {
        const { root, resources } = await this._getResources(model)
        if (resources.length === 0) {
            // packTarArchive fails otherwise
            this.handler.pushMessage("No deployment resources found - skip resources.tgz", WARNING)
            return
        }
        await this.writeTarFile(path.join(dest, DEFAULT_TAR_NAME), root, resources)
    }

    /**
     * Creates a TAR file at the given absolute tarPath. An optional resources list holds the files and folders 
     * that will be added to the TAR. Paths are relative to the passed root directory. If omitted, the entire 
     * root directory contents will be added. 
     * @param {*} tarFile Absolute TAR file name.
     * @param {*} root The root directory the passed resources are relative to.
     * @param {*} resources Optional list of absolute or relative resource paths - relative to the given root directory. 
     * If omitted all resources contained in the root directory are added to the TAR file.
     */
    async writeTarFile(tarFile, root, resources) {
        const { tar } = require('../../../../lib').utils
        await tar.czfd(tarFile, root, resources)
        this.handler.pushFile(tarFile)
    }

    async _getResources(model) {
        // distinguish HANA and SQLITE deployment
        let root = await this._getHanaTenantDbDest()
        let resources
        if (root) {
            resources = this._getHanaResources(root)
        } else {
            root = this.handler.buildOptions.root
            resources = await this._getSqliteResources(model)
        }
        return { root, resources }
    }

    /**
     * Reads a list of files and folders required for HANA deployment.
     * This is a subset of all files contained in the directory.
     * - 'db/src', 'db/cfg', 'db/undeploy.json'...
     * See '../../../../lib.deploy'
     * Note: the hana build task has already been executed
     * @param {string} root
     * @returns an array containing all resources
     */
    _getHanaResources(root) {
        return ['src', 'cfg', 'undeploy.json', '.hdiignore'].reduce((acc, res) => {
            const resPath = path.join(root, res)
            if (fs.existsSync(resPath)) {
                acc.push(resPath)
            }
            return acc
        }, [])
    }

    /**
     * Reads all resources for Sqlite deployment - see '../../../../lib.deploy'
     *
     * @param {object} model
     * @returns
     */
    async _getSqliteResources(model) {
        const { resources } = cds.deploy
        return Object.keys(await resources(model))
    }

    async _getHanaTenantDbDest() {
        const buildOptions = this.handler.buildOptions
        let hanaTask = buildOptions.tasks ? buildOptions.tasks.find(task => task.for === BUILD_TASK_HANA) : undefined
        if (!hanaTask) {
            this.handler.pushMessage(`Found SQLite database configuration. Ensure that productive cloud deployments requiring SAP HANA database are built with 'production' profile.`, WARNING)
            return null
        }
        return hanaTask.dest
    }
}
module.exports = ResourcesTarBuilder
