const cds = require('../../cds')
const _transform = o => ({ subdomain: o.subscribedSubdomain, tenant: o.subscribedTenantId })

// REVISIT: Looks ugly -> can we simplify that?
const getTenantInfo = async tenant => {
  const provisioningServiceName = cds.mtx ? 'ProvisioningService' : 'cds.xt.SaasProvisioningService'
  const primaryKey = cds.mtx ? 'ID' : 'subscribedTenantId'
  const path = cds.mtx ? 'tenant' : '/tenant' // HACK, otherwise the API doesn't work

  const provisioning = await cds.connect.to(provisioningServiceName)
  const tx = provisioning.tx({ user: new cds.User.Privileged() })
  try {
    const result = tenant
      ? _transform(await tx.get(path, { [primaryKey]: tenant }))
      : (await tx.read('tenant')).map(o => _transform(o))
    await tx.commit()
    return result
  } catch (e) {
    try {
      await tx.rollback()
      throw e
    } catch (_) {
      throw e
    }
  }
}

module.exports = getTenantInfo
