module.exports = function basic_auth (options) {

  const cds = require ('../index'), LOG = cds.log('auth'), { decodeURIComponent } = cds.utils
  const users = require ('./mocked-users') (options)
  const login_required = options.login === 'required' || process.env.NODE_ENV === 'production' && options.credentials || cds.requires.multitenancy

  /** @type { import('express').Handler } express_handler */
  return async function basic_auth (req, res, next) {
    // allow subsequent code to request a user login
    req.login = login
    // get basic authorization header
    let auth = req.headers.authorization
    // enforce login if requested
    if (!auth) return login_required ? req.login('Logged in user required!') : next()
    // decode user credentials from autorization header
    let [id,pwd] = Buffer.from(auth.slice(6),'base64').toString().split(':')
    // verify user credentials and set req.user
    let u = req.user = await users.verify (id, pwd)
    // re-request login in case of wrong credentials
    if (u.failed) return req.login (u)
    // support for feature toggles via req.headers.features
    if (req.headers.features) u = req.user = { ...u, features: req.headers.features } // NOTE: need to clone u
    // done...
    if (LOG._debug) LOG.debug('authenticated user:', u)
    next()
  }

  function login (reason='') {
    const req=this, res=req.res
    res.set ('WWW-Authenticate', `Basic realm="Users"`) .sendStatus (401)
    LOG.info (req.method, decodeURIComponent(req.path), '>', res.statusCode, res.statusMessage, ...(!reason ? [] : ['-', reason]))
  }
}
