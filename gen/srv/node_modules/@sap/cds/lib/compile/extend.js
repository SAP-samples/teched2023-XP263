const compile = require ('./cds-compile')
const { extend } = require ('../lazy')

module.exports = o => o.definitions ? { with(...csns) {

  const csn=o, merged = { definitions: {}, extensions: [] }
  for (const { definitions, extensions } of csns) {
    if (definitions) Object.assign(merged.definitions, definitions)
    if (extensions) merged.extensions.push(...extensions)
  }
  const extended = compile({
    'base.csn': compile.to.json(csn),
    'ext.csn': compile.to.json(merged)
  })
  extended.$sources = csn.$sources // required to load resources like i18n later on
  return extended

}} : extend(o)
