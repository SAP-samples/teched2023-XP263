const cds = require ('../../index')

module.exports = function cds_compile_for_java (csn,o) {
  if ('_4java' in csn) return csn._4java
  let dsn = csn // cds.minify (csn)
  dsn = cds.compile.for.drafts (csn,o)
  if (dsn.definitions) for (let [name,d] of Object.entries(dsn.definitions)) {
    // Add @cds.external to external services
    if (d.kind === 'service' && name in cds.requires) d['@cds.external'] = true
    // Add parsed ._where clause to @restrict annotations
    const rr = d['@restrict']
    if (rr) for (let r of rr) if (r.grant && r.where) try {
      r._where = JSON.stringify (cds.parse.xpr(r.where))
    } catch(e){/* ignored */}
  }
  Object.defineProperty (csn, '_4java', {value:dsn})
  Object.defineProperty (dsn, '_4java', {value:dsn})
  return dsn
}