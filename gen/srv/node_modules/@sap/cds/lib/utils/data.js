const cds = require('../index')

class DataUtil {

  async delete(db) {
    if (!db)  db = await cds.connect.to('db')
    if (!this._deletes) {
      this._deletes = []
      for (const entity of db.model.each('entity')) {
        if (!entity.query && entity['@cds.persistence.skip'] !== true) {
          this._deletes.push(cds.ql.DELETE.from(entity))
        }
      }
    }
    if (this._deletes.length > 0) {
      const LOG = cds.log('deploy')
      if (!this._autoReset)  LOG.info('Deleting all data for', db.model.each('entity'))
      await db.run(this._deletes)
    }
  }

  /* delete + new deploy from csv */
  async reset(db) {
    if (!db)  db = await cds.connect.to('db')
    await this.delete(db)
    await cds.deploy.init(db)
  }

  autoReset(enabled) { this._autoReset = enabled; return this }

}

module.exports = DataUtil

/* eslint no-console: off */
