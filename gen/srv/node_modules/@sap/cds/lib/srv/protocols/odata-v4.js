const cds = require('../../index'), { User } = cds, { decodeURIComponent } = cds.utils
const libx = require('../../../libx/_runtime')
const LOG = cds.log('odata')

module.exports = function ODataAdapter (srv) { return [
  (req, _, next) => {
    let u = req.user
    req.user = u instanceof User ? u : new User(u)
    req.on ('dispatch', (eve) => {
      LOG && LOG (req.method, req.baseUrl + decodeURIComponent(eve._path), eve._query||'')
      if (LOG._debug && eve.query) LOG.debug (eve.query)
    })
    next()
  },
  libx.to.odata_v4 (srv)
]}
