const cds = require ('../../index'), { decodeURIComponent } = cds.utils
const LOG = cds.log('graphql')

const GraphQLAdapter = require('@cap-js/graphql') // eslint-disable-line cds/no-missing-dependencies
const express = require ('express') // eslint-disable-line cds/no-missing-dependencies

function CDSGraphQLAdapter (options) {

  const {services} = options

  return express.Router()
  .use (express.json()) //> required in the slug handlers and logger below

  /** Convenience slug route for /graphql/srv/entity/id */
  .use ('/:path/:entity/:id?(%20:query)?', (req,_,next) => {
    // TODO: add filter by id -> then remove the // eslint-disable-line
    let { entity, id, query } = req.params // eslint-disable-line no-unused-vars
    if (query) req.body = { query }
    if (entity) req.body.query = req.body.query.replace(/{/, `{ ${entity} {`) +'}'
    next() //> goes on below
  })

  /** Convenience slug route for /graphql/srv */
  .use ('/:path', (req, res, next) => {
    let srv = services [req.params.path]
    if (req.body) req.body.query = req.body.query.replace(/{/, `{ ${srv.name} {`) +'}'
    next() //> goes on below
  })

  .use ((req,_,next)=>{
    LOG.info (req.method, req.body?.query || decodeURIComponent(req.query.query))
    next()
  })

  /** The global /graphql route */
  .use (new GraphQLAdapter (options))
}

module.exports = CDSGraphQLAdapter
